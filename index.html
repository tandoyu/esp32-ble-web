<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>ESP32 BLE Steuerung</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  button, input { margin: 5px 0; padding: 8px; font-size: 16px; }
</style>
</head>
<body>
  <h1>ESP32 BLE Steuerung</h1>
  <button id="connectBtn">Verbinden</button><br />

  <label for="codeInput">Zugangscode eingeben:</label><br />
  <input type="text" id="codeInput" placeholder="Code" />
  <button id="sendCodeBtn" disabled>Code senden</button><br />

  <button id="ledOnBtn" disabled>LED AN</button>
  <button id="ledOffBtn" disabled>LED AUS</button><br />

  <div id="log"></div>

<script>
  const SERVICE_UUID = '12345678-1234-1234-1234-123456789abc';
  const CHARACTERISTIC_UUID = 'abcdefab-1234-5678-1234-abcdefabcdef';

  let bleDevice;
  let characteristic;

  const log = msg => {
    const logDiv = document.getElementById('log');
    logDiv.innerHTML += msg + '<br />';
    logDiv.scrollTop = logDiv.scrollHeight;
  };

  document.getElementById('connectBtn').onclick = async () => {
    try {
      log('Suche BLE-GerÃ¤t...');
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ services: [SERVICE_UUID] }]
      });

      log('Verbinde mit GATT Server...');
      const server = await bleDevice.gatt.connect();

      log('Hole Service...');
      const service = await server.getPrimaryService(SERVICE_UUID);

      log('Hole Characteristic...');
      characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

      document.getElementById('sendCodeBtn').disabled = false;
      document.getElementById('ledOnBtn').disabled = false;
      document.getElementById('ledOffBtn').disabled = false;

      log('Verbunden! Du kannst jetzt Code senden oder LED schalten.');
    } catch (error) {
      log('Fehler: ' + error);
    }
  };

  async function writeValue(value) {
    if (!characteristic) {
      log('Nicht verbunden!');
      return;
    }
    try {
      const encoder = new TextEncoder();
      await characteristic.writeValue(encoder.encode(value));
      log('Gesendet: ' + value);
    } catch (error) {
      log('Fehler beim Senden: ' + error);
    }
  }

  document.getElementById('sendCodeBtn').onclick = () => {
    const code = document.getElementById('codeInput').value.trim();
    if (code.length === 0) {
      alert('Bitte Code eingeben!');
      return;
    }
    writeValue(code);
  };

  document.getElementById('ledOnBtn').onclick = () => {
    writeValue('1');
  };

  document.getElementById('ledOffBtn').onclick = () => {
    writeValue('0');
  };
</script>
</body>
</html>
