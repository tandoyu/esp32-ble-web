<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BlinkSave Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #d82e21; /* Vespa Rot */
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button {
            background-color: #d82e21;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            min-width: 200px;
        }
        button:hover {
            background-color: #b8241a;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #blinkerIndicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            background: grey;
            margin-left: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .status {
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        input {
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            max-width: 200px;
        }
        .error {
            color: #d82e21;
            margin: 10px 0;
        }
        .success {
            color: #28a745;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>BlinkSave Pro</h1>
    </div>
    
    <div class="section">
        <h2>Verbindung</h2>
        <button id="connectBtn">Mit BlinkSave Pro verbinden</button>
        <div class="status">
            <strong>Status:</strong> <span id="connectionStatus">Nicht verbunden</span>
        </div>
    </div>
    
    <div id="authSection" class="section" style="display:none;">
        <h2>Sicherheit</h2>
        <div class="status">
            <strong>Code Status:</strong> <span id="codeState">-</span>
        </div>
        <div id="codeInputArea"></div>
        <div id="authMessage" style="display:none;"></div>
    </div>
    
    <div id="blinkerSection" class="section" style="display:none;">
        <h2>BlinkSave <span id="blinkerIndicator"></span></h2>
        <div class="status">
            <strong>Aktueller Status:</strong> <span id="blinkerStatus">-</span>
        </div>
        <button id="blinkerOnBtn" disabled>BlinkSave EIN</button>
        <button id="blinkerOffBtn" disabled>BlinkSave AUS</button>
    </div>

    <script>
        let device;
        let txCharacteristic;
        let rxCharacteristic;
        let codeIsSet = false;
        let isAuthenticated = false;

        async function connect() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: "BlinkSave Pro" }],
                    optionalServices: [0xFFE0]
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0xFFE0);
                
                txCharacteristic = await service.getCharacteristic(0xFFE2);
                rxCharacteristic = await service.getCharacteristic(0xFFE1);
                
                txCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                await txCharacteristic.startNotifications();
                
                document.getElementById('connectionStatus').textContent = "Verbunden";
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('blinkerSection').style.display = 'block';
                
                await sendCommand("GETSTATUS");
                
            } catch(error) {
                console.error('Fehler:', error);
                document.getElementById('connectionStatus').textContent = "Fehler: " + error.message;
            }
        }

        function handleNotifications(event) {
            const value = new TextDecoder().decode(event.target.value);
            console.log("Empfangen:", value);
            
            // Blinker Status
            if (value.includes("BLINKER:1")) {
                document.getElementById('blinkerStatus').textContent = "AKTIV";
                document.getElementById('blinkerIndicator').style.backgroundColor = '#d82e21';
                document.getElementById('blinkerIndicator').style.animation = "blink 1s infinite";
            } else if (value.includes("BLINKER:0")) {
                document.getElementById('blinkerStatus').textContent = "INAKTIV";
                document.getElementById('blinkerIndicator').style.backgroundColor = 'grey';
                document.getElementById('blinkerIndicator').style.animation = "none";
            }
            
            // Code Status
            if (value.includes("CODE:SET")) {
                codeIsSet = true;
                document.getElementById('codeState').textContent = "Gespeichert";
            } else if (value.includes("CODE:NONE")) {
                codeIsSet = false;
                document.getElementById('codeState').textContent = "Nicht gespeichert";
            }
            
            // Authentifizierung
            if (value.includes("AUTH:1")) {
                isAuthenticated = true;
                updateUI();
            } else if (value.includes("AUTH:0")) {
                isAuthenticated = false;
                updateUI();
            }
            
            // Nachrichten
            const authMsg = document.getElementById('authMessage');
            if (value === "AUTH_OK") {
                authMsg.textContent = "Erfolgreich authentifiziert!";
                authMsg.className = "success";
                authMsg.style.display = "block";
                setTimeout(() => authMsg.style.display = "none", 3000);
            } else if (value === "AUTH_FAIL") {
                authMsg.textContent = "Falscher Code!";
                authMsg.className = "error";
                authMsg.style.display = "block";
            }
        }

        function updateUI() {
            const codeArea = document.getElementById('codeInputArea');
            codeArea.innerHTML = '';
            
            if (!isAuthenticated) {
                if (codeIsSet) {
                    codeArea.innerHTML = `
                        <input type="password" id="codeInput" placeholder="Sicherheitscode">
                        <button id="authBtn">Authentifizieren</button>
                    `;
                    document.getElementById('authBtn').addEventListener('click', authenticate);
                } else {
                    codeArea.innerHTML = `
                        <p>Erstellen Sie einen Sicherheitscode:</p>
                        <input type="password" id="newCode" placeholder="4-16 Zeichen">
                        <button id="setCodeBtn">Code speichern</button>
                    `;
                    document.getElementById('setCodeBtn').addEventListener('click', setCode);
                }
                
                document.getElementById('blinkerOnBtn').disabled = true;
                document.getElementById('blinkerOffBtn').disabled = true;
            } else {
                codeArea.innerHTML = `
                    <button id="logoutBtn">Abmelden</button>
                    ${codeIsSet ? '<button id="changeCodeBtn">Code Ã¤ndern</button>' : ''}
                `;
                document.getElementById('logoutBtn').addEventListener('click', logout);
                if (codeIsSet) {
                    document.getElementById('changeCodeBtn').addEventListener('click', showCodeChange);
                }
                
                document.getElementById('blinkerOnBtn').disabled = false;
                document.getElementById('blinkerOffBtn').disabled = false;
            }
        }

        async function sendCommand(cmd) {
            if (!rxCharacteristic) return;
            const encoder = new TextEncoder();
            await rxCharacteristic.writeValue(encoder.encode(cmd));
        }

        async function authenticate() {
            const code = document.getElementById('codeInput').value;
            if (code.length >= 4) {
                await sendCommand("CHECKCODE:" + code);
            } else {
                alert("Code muss mindestens 4 Zeichen haben!");
            }
        }

        async function setCode() {
            const code = document.getElementById('newCode').value;
            if (code.length >= 4 && code.length <= 16) {
                await sendCommand("SETCODE:" + code);
                alert("Sicherheitscode gespeichert!");
            } else {
                alert("Code muss 4-16 Zeichen haben!");
            }
        }

        async function logout() {
            await sendCommand("LOGOUT");
        }

        function showCodeChange() {
            const codeArea = document.getElementById('codeInputArea');
            codeArea.innerHTML = `
                <p>Aktuellen Code bestÃ¤tigen:</p>
                <input type="password" id="currentCode" placeholder="Aktueller Code">
                <p>Neuen Code eingeben:</p>
                <input type="password" id="newChangeCode" placeholder="Neuer Code">
                <button id="confirmChangeBtn">Ãndern</button>
                <button id="cancelChangeBtn">Abbrechen</button>
            `;
            document.getElementById('confirmChangeBtn').addEventListener('click', changeCode);
            document.getElementById('cancelChangeBtn').addEventListener('click', updateUI);
        }

        async function changeCode() {
            const current = document.getElementById('currentCode').value;
            const newCode = document.getElementById('newChangeCode').value;
            
            if (current && newCode.length >= 4 && newCode.length <= 16) {
                await sendCommand("CHECKCODE:" + current);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (isAuthenticated) {
                    await sendCommand("SETCODE:" + newCode);
                    alert("Code erfolgreich geÃ¤ndert!");
                    updateUI();
                }
            } else {
                alert("UngÃ¼ltige Eingabe!");
            }
        }

        // Event Listener
        document.getElementById('connectBtn').addEventListener('click', connect);
        document.getElementById('blinkerOnBtn').addEventListener('click', () => sendCommand("BLINKSAVE_EIN"));
        document.getElementById('blinkerOffBtn').addEventListener('click', () => sendCommand("BLINKSAVE_AUS"));

        // Blinkanimation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0.3; }
                100% { opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        // Initialisierung
        if (!navigator.bluetooth) {
            document.getElementById('connectionStatus').textContent = 
                "Web Bluetooth wird von diesem Browser nicht unterstÃ¼tzt";
            document.getElementById('connectBtn').disabled = true;
        }
    </script>
</body>
</html>
