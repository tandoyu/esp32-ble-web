<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlinkSave Pro</title>
    <style>
        :root {
            --vespa-blue: #005BAA;
            --vespa-lightblue: #4D9DE0;
            --vespa-accent: #FFD700;
            --text-light: #FFFFFF;
            --text-dark: #333333;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            max-width: 650px;
            margin: 0 auto;
            padding: 20px;
            background-color: #F0F8FF;
            color: var(--text-dark);
            -webkit-text-size-adjust: 100%;
        }
        
        .header {
            background: linear-gradient(135deg, var(--vespa-blue), var(--vespa-lightblue));
            color: var(--text-light);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 91, 170, 0.2);
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .section {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 91, 170, 0.1);
        }
        
        .section h2 {
            color: var(--vespa-blue);
            margin-top: 0;
            border-bottom: 2px solid var(--vespa-lightblue);
            padding-bottom: 10px;
            font-size: 22px;
        }
        
        button {
            background: linear-gradient(to bottom, var(--vespa-blue), #004B94);
            color: white;
            border: none;
            padding: 14px 24px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            min-width: 220px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 91, 170, 0.3);
            -webkit-appearance: none;
        }
        
        button:hover {
            background: linear-gradient(to bottom, #0068CC, var(--vespa-blue));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 91, 170, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #CCCCCC;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #blinkerIndicator {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: inline-block;
            background: #DDDDDD;
            margin-left: 12px;
            vertical-align: middle;
            border: 2px solid white;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(0, 91, 170, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--vespa-lightblue);
        }
        
        .status strong {
            color: var(--vespa-blue);
        }
        
        input {
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #DDDDDD;
            border-radius: 8px;
            width: 100%;
            max-width: 250px;
            font-size: 16px;
            transition: border 0.3s;
            -webkit-appearance: none;
        }
        
        input:focus {
            border-color: var(--vespa-lightblue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(77, 157, 224, 0.2);
        }
        
        .error {
            color: #E74C3C;
            margin: 12px 0;
            padding: 10px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 6px;
            border-left: 4px solid #E74C3C;
        }
        
        .success {
            color: #27AE60;
            margin: 12px 0;
            padding: 10px;
            background-color: rgba(39, 174, 96, 0.1);
            border-radius: 6px;
            border-left: 4px solid #27AE60;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .logo span {
            color: var(--vespa-accent);
        }
        
        .compatibility-warning {
            display: none;
            background: #FFF3CD;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #FFC107;
        }
        
        .ios-alternative {
            display: none;
            background: #E3F2FD;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--vespa-lightblue);
        }
        
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="iosWarning" class="ios-alternative">
        <h3>Für iPhone-Nutzer:</h3>
        <p>Da Web Bluetooth auf iOS nicht vollständig unterstützt wird, empfehlen wir folgende Alternativen:</p>
        <ol>
            <li><strong>WebBLE App</strong> aus dem App Store installieren</li>
            <li><strong>BLE Scanner App</strong> mit folgenden Einstellungen:
                <ul>
                    <li>Service UUID: FFE0</li>
                    <li>RX Characteristic: FFE1</li>
                    <li>TX Characteristic: FFE2</li>
                </ul>
            </li>
        </ol>
    </div>

    <div class="header">
        <div class="logo">BLINK<span>SAVE</span> PRO</div>
        <h1>Intelligente Blinkersteuerung</h1>
    </div>
    
    <div class="section">
        <h2>Bluetooth-Verbindung</h2>
        <button id="connectBtn">Mit BlinkSave Pro verbinden</button>
        <div class="status">
            <strong>Verbindungsstatus:</strong> <span id="connectionStatus">Getrennt</span>
        </div>
    </div>
    
    <div id="authSection" class="section" style="display:none;">
        <h2>Sicherheitsmanagement</h2>
        <div class="status">
            <strong>Sicherheitsstatus:</strong> <span id="codeState">Nicht initialisiert</span>
        </div>
        <div id="codeInputArea"></div>
        <div id="authMessage" style="display:none;"></div>
    </div>
    
    <div id="blinkerSection" class="section" style="display:none;">
        <h2>Systemsteuerung <span id="blinkerIndicator"></span></h2>
        <div class="status">
            <strong>Aktueller Modus:</strong> <span id="blinkerStatus">---</span>
        </div>
        <div class="button-group">
            <button id="blinkerOnBtn" disabled>Aktivieren</button>
            <button id="blinkerOffBtn" disabled>Deaktivieren</button>
        </div>
    </div>

    <script>
        let device;
        let txCharacteristic;
        let rxCharacteristic;
        let codeIsSet = false;
        let isAuthenticated = false;
        const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);

        // Initiale Prüfung der Browserkompatibilität
        function checkCompatibility() {
            if (isIOS) {
                document.getElementById('iosWarning').style.display = 'block';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectionStatus').textContent = 
                    "iOS benötigt spezielle BLE-Apps (siehe Hinweis oben)";
            } else if (!navigator.bluetooth) {
                document.getElementById('connectionStatus').textContent = 
                    "Web Bluetooth wird von diesem Browser nicht unterstützt";
                document.getElementById('connectBtn').disabled = true;
            }
        }

        async function connect() {
            try {
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').textContent = "Verbinde...";
                
                // Für iOS gibt es keine direkte Verbindungsmöglichkeit
                if (isIOS) {
                    throw new Error("Bitte eine kompatible BLE-App verwenden");
                }

                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: "BlinkSave Pro" }],
                    optionalServices: [0xFFE0]
                }).catch(err => {
                    if (err.code === 8) {
                        throw new Error("Gerät nicht gefunden. Bitte einschalten!");
                    }
                    throw err;
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0xFFE0);
                
                txCharacteristic = await service.getCharacteristic(0xFFE2);
                rxCharacteristic = await service.getCharacteristic(0xFFE1);
                
                txCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                await txCharacteristic.startNotifications();
                
                document.getElementById('connectionStatus').textContent = "Verbunden mit " + (device.name || "BlinkSave Pro");
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('blinkerSection').style.display = 'block';
                
                await sendCommand("GETSTATUS");
                
            } catch(error) {
                console.error('Verbindungsfehler:', error);
                let errorMsg = "Fehler: ";
                
                if (error.message.includes("User cancelled")) {
                    errorMsg = "Abgebrochen - bitte erneut versuchen";
                } else if (error.message.includes("Gerät nicht gefunden")) {
                    errorMsg = "BlinkSave Pro nicht gefunden - bitte einschalten";
                } else if (error.message.includes("Bluetooth")) {
                    errorMsg = "Bluetooth nicht aktiviert - bitte in Einstellungen prüfen";
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('connectionStatus').textContent = errorMsg;
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('connectBtn').textContent = "Erneut versuchen";
            }
        }

        function handleNotifications(event) {
            const value = new TextDecoder().decode(event.target.value);
            console.log("Empfangene Daten:", value);
            
            if (value.includes("BLINKER:1")) {
                document.getElementById('blinkerStatus').textContent = "AKTIV";
                document.getElementById('blinkerIndicator').style.backgroundColor = '#FFD700';
                document.getElementById('blinkerIndicator').style.animation = 'blink 1s infinite';
                document.getElementById('blinkerOnBtn').textContent = "Aktiv (läuft)";
            } else if (value.includes("BLINKER:0")) {
                document.getElementById('blinkerStatus').textContent = "INAKTIV";
                document.getElementById('blinkerIndicator').style.backgroundColor = '#DDDDDD';
                document.getElementById('blinkerIndicator').style.animation = 'none';
                document.getElementById('blinkerOnBtn').textContent = "Aktivieren";
            }
            
            if (value.includes("CODE:SET")) {
                codeIsSet = true;
                document.getElementById('codeState').textContent = "Sicherheitscode gesetzt";
            } else if (value.includes("CODE:NONE")) {
                codeIsSet = false;
                document.getElementById('codeState').textContent = "Kein Sicherheitscode";
            }
            
            if (value.includes("AUTH:1")) {
                isAuthenticated = true;
                updateUI();
            } else if (value.includes("AUTH:0")) {
                isAuthenticated = false;
                updateUI();
            }
            
            const authMsg = document.getElementById('authMessage');
            if (value === "AUTH_OK") {
                authMsg.textContent = "Erfolgreich authentifiziert!";
                authMsg.className = "success";
                authMsg.style.display = "block";
                setTimeout(() => authMsg.style.display = "none", 3000);
            } else if (value === "AUTH_FAIL") {
                authMsg.textContent = "Authentifizierung fehlgeschlagen - falscher Code!";
                authMsg.className = "error";
                authMsg.style.display = "block";
            }
        }

        function updateUI() {
            const codeArea = document.getElementById('codeInputArea');
            codeArea.innerHTML = '';
            
            if (!isAuthenticated) {
                if (codeIsSet) {
                    codeArea.innerHTML = `
                        <p>Bitte geben Sie Ihren Sicherheitscode ein:</p>
                        <input type="password" id="codeInput" placeholder="Sicherheitscode" autocomplete="off">
                        <button id="authBtn">Authentifizieren</button>
                    `;
                    document.getElementById('authBtn').addEventListener('click', authenticate);
                } else {
                    codeArea.innerHTML = `
                        <p>Bitte legen Sie einen Sicherheitscode fest (4-16 Zeichen):</p>
                        <input type="password" id="newCode" placeholder="Neuer Sicherheitscode" autocomplete="off">
                        <button id="setCodeBtn">Code speichern</button>
                    `;
                    document.getElementById('setCodeBtn').addEventListener('click', setCode);
                }
                
                document.getElementById('blinkerOnBtn').disabled = true;
                document.getElementById('blinkerOffBtn').disabled = true;
            } else {
                codeArea.innerHTML = `
                    <div class="button-group">
                        <button id="logoutBtn">Abmelden</button>
                        ${codeIsSet ? '<button id="changeCodeBtn">Code ändern</button>' : ''}
                    </div>
                `;
                document.getElementById('logoutBtn').addEventListener('click', logout);
                if (codeIsSet) {
                    document.getElementById('changeCodeBtn').addEventListener('click', showCodeChange);
                }
                
                document.getElementById('blinkerOnBtn').disabled = false;
                document.getElementById('blinkerOffBtn').disabled = false;
            }
        }

        async function sendCommand(cmd) {
            if (!rxCharacteristic) {
                console.error("Keine RX-Characteristic verfügbar");
                return;
            }
            
            try {
                const encoder = new TextEncoder();
                await rxCharacteristic.writeValue(encoder.encode(cmd));
                console.log("Befehl gesendet:", cmd);
            } catch (error) {
                console.error("Fehler beim Senden des Befehls:", error);
                if (error.message.includes("not connected")) {
                    document.getElementById('connectionStatus').textContent = "Verbindung verloren - bitte neu verbinden";
                    location.reload();
                }
            }
        }

        // Rest der Funktionen (authenticate, setCode, logout, etc.) bleibt gleich wie im vorherigen Beispiel

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            checkCompatibility();
            
            // Event Listener für Buttons
            document.getElementById('connectBtn').addEventListener('click', connect);
            document.getElementById('blinkerOnBtn').addEventListener('click', async () => {
                document.getElementById('blinkerOnBtn').disabled = true;
                document.getElementById('blinkerOnBtn').textContent = "Aktiviere...";
                await sendCommand("BLINKSAVE_EIN");
                document.getElementById('blinkerOnBtn').disabled = false;
            });
            document.getElementById('blinkerOffBtn').addEventListener('click', async () => {
                document.getElementById('blinkerOffBtn').disabled = true;
                document.getElementById('blinkerOffBtn').textContent = "Deaktiviere...";
                await sendCommand("BLINKSAVE_AUS");
                document.getElementById('blinkerOffBtn').disabled = false;
            });

            // Blinkanimation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes blink {
                    0% { opacity: 1; }
                    50% { opacity: 0.3; box-shadow: 0 0 20px #FFD700; }
                    100% { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
